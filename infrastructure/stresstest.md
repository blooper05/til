### Chapter 2
- 人類はオンプレからクラウドへ移行することで高い可用性とスケール性を手に入れた

### Chapter 3
- 負荷試験の目的
    - ユースケースごとの応答性能の推測
    - 高負荷時における性能改善
    - 目的の性能を提供するために必要なハードウェアの選定
    - スケール性の確認
    - スケール特性の把握
        - スループットのレベルごとに最適なインフラ構成の把握
            - マストで把握しておくべき
            - 例えば、2倍のスループットを実現するためにはWEBサーバの数を増やすだけで良いのか、DBのスケールアップも必要なのか
            - 例えば、半分のスループットで良いときに何を削除可能なのか
            - それらの変更はサービス停止なしで行えるのか否か
        - スループットの限界性能の把握
            - マストではない
            - サービスが成長した場合に、そのままスケールすればよいのか、アーキテクチャの再設計が必要なのか、の判断材料になる
- 性能指標
    - スループット
        - 単位時間あたりに目的地に到着する自動車の数
        - rps: 1秒間に処理を行うHTTPリクエストの数
    - レイテンシ
        - 自動車で目的地にたどり着くまでの所要時間
        - 「ユーザーから見た処理時間」と「システムから見た処理時間」
- 性能改善
    - スループットの改善
        - ボトルネックを特定し強化する
        - 1つのボトルネックを強化すると別の箇所がボトルネックとなる
            - 「ボトルネックは移動する」
    - レイテンシの改善
        - 処理時間の大きい処理から改善を検討していく
            - アプリケーション実装が対象となることが多い
            - プロファイラーなどを利用して処理時間を計測すると良い
        - レイテンシは「待ち時間も含めた各サブシステムの処理時間の総和」なので、待ち時間＝スループットの改善がレイテンシの改善につながることも多い
- 良い負荷試験であることを示す指標
    - 試験対象システムに負荷が集中している状態
        - 試験対象システムに負荷を集中させるためには、一部本番環境と異なる構成を取ってもよい
    - ボトルネック部分を特定できている状態

### Chapter 4
- 攻撃ツール
    - 攻撃ツールによって計測されるレイテンシは全体のレイテンシのみで、サブシステムごとのレイテンシは別途ツール導入が必要
    - 攻撃ツールによるリクエスト生成と実際のユーザーアクセスによるリクエスト生成は異なることに注意
        - 攻撃サーバ数が限られているため、リクエスト元の負荷やネットワーク帯域の問題が発生する
            - 例えばSSL接続やHTTPリクエストの切断・再接続もコストとなる
        - DNS情報のキャッシュにより特定のエンドポイントに負荷が集中してしまう
            - 試験対象システムの近くから攻撃する
            - リクエストが分散していることを常にチェックする
        - リクエストが返ってくるまで次のリクエストを出せないので、実際のようには同時リクエスト数が増やせない
        - 一部の遅い処理が全体のスループットに大きく影響しやすい
    - 攻撃ツールにはそれぞれ特性があるため、負荷試験の規模や目的に応じて使い分ける
        - リクエストごとに異なるパラメータを付ける必要がある
            - 複雑なシナリオが組めるツールを利用する
        - かなりの高スループットが要求される
            - 複数台の攻撃サーバからの攻撃に対応するツールを利用する
        - 長時間の負荷をかける耐久試験
            - 長時間の攻撃に耐えうる安定したツールを利用する
- モニタリングツール
    - モニタリングしておきたい項目
        - ネットワーク
            - 転送量
        - ハードウェア・OS
            - CPU
            - メモリ
            - プロセス数
            - SWAP
            - Load Average
        - TCP
            - 外部へのコネクション状況
        - ディスク
            - IOPS
            - Read・Write 転送データ量
        - ミドルウェア
            - コネクション数
        - アプリケーション
            - プロファイリング
        - RDB
            - Slow Query
            - Process List
    - top コマンド
        - CPU使用率
            - ユーザープロセス：ミドルウェアや、アプリケーションのプログラム実行
            - システムプロセス：ファイルやネットワークの入出力など
            - 前者が高いのは良い負荷試験
            - 意図せず後者が高い場合は設定などを確認すべき
            - `1` 押下で論理コア別の使用率が確認出来る
        - メモリ使用量
            - total・used・free の値を注視する
    - netstat コマンド
        - `netstat nato`
        - State が TIME_WAIT になっているコネクション数を注視する
    - Amazon CloudWatch
        - ネットワークを含まないシステム全体のレイテンシ計測にはロードバランサーのモニタリングが必要
        - EC2 の「詳細モニタリングを有効化」して、最低でも3分間以上、負荷を継続してかけること
            - ピーク時の数値をモニタリングするため
- プロファイリングツール
    - XHProf
        - PHPアプリケーション用プロファイリングツール
    - New Relic
        - お馴染みのやつ

### Chapter 5
- 負荷試験計画の立案
    - スケジュール
        - 負荷試験は工数や期間が見積もりにくい
            - PDCA の Action の部分に不確定要素が多いため
        - 余裕を持ったスケジュールを組んでおくことが肝要
            - 筆者は最低でも1〜2週間は見込んでおくとのこと
    - 目的
        - Chapter 3 参照
        - どのようなユースケースに対して試験するのかもこの時点で決めておく
            - サービス利用開始直後にユーザーが大量に登録をする
            - サービスが順調に稼働したあとにデータが大量に溜まった
            - キャンペーン告知などで急激なユーザーアクセスが見込まれる
            - バッチなどの他システムによるDB操作作業とバッティングする
            - システムが異常系の応答を返す
            - システムの再起動直後などでキャッシュが揮発している
    - 前提条件の整理
        - 試験対象となるシステムの範囲
        - データ量（件数・容量）
            - サービス利用者数、想定ユーザー行動、利用期間などから概算する
        - 外部システムのレイテンシ、利用するシステムの制約
            - 外部システムのスループットやレイテンシを把握する必要がある
            - 最大可能同時接続数や単位時間あたりの呼び出し回数制限などの制約がある場合もあるので注意
            - 結合した状態でのテストが難しい場合、どう対処するのかも考える必要がある
        - 継続的な性能維持期間
            - 「X時間以上継続して性能を維持すること」
        - 負荷のかけ方
            - どこのネットワークから負荷をかけるか
            - HTTPS を使うのか否か
        - その他
            - サーバに同居する別のシステムの影響が発生する可能性などの洗い出し
            - 実施スケジュールの制約や環境的な制約などの洗い出し
            - その他、本番環境と試験環境の差異による影響の確認
    - 目標値
        - レイテンシ
            - ユーザビリティの観点からプロジェクトで決めた最低限の基準
                - 一般的な WEB システムなら 50ms 〜 100ms が1つの目安
                - すべての処理は常にこれを下回るようにする
            - 低～中程度のスループットがあるときの各処理の基本的な応答時間
                - 高負荷時にもBのX倍（たとえば2倍）を下回るようにする
                - レイテンシとスループットの関係をグラフにプロットすると改善ポイントが見つけやすい
        - スループット
            - 以下により求めた最大 rps に安全係数 2〜3 を乗じた値を目標値とする
                ```
                1日の利用者数（人／日）×1人あたりの1日の平均アクセス数（回／人）＝1日の総アクセス数（回／日）
                1日の総アクセス数（回／日）÷1日の秒数86,400（秒／日）＝1日の平均rps（回／秒）
                1日の平均rps（回／秒）×1日の平均アクセス数に対する最大ピーク時の倍率＝最大rps（回／秒）
                ```
            - 1日の利用者数
                - DAU に相当する
                - 1,000人なのか10,000人なのか100,000人なのか、という程度のオーダーの見積りで OK
            - 1人あたりの1日の平均アクセス数
                - サービス利用者のほとんどはライトユーザーなので、典型的なライトユーザーの利用シナリオの2～3倍程度を平均としておけば大きな間違いは起こらない（筆者経験則）
            - 1日の平均アクセス数に対する最大ピーク時の倍率
                - 時間帯によるサービスの変動がない標準的なサービスの場合、おおむねピーク時には平均の約2～3倍のアクセスがある場合が多い（筆者経験則）
                - グローバルに利用されるサービスであれば、時差によりピークが重なり合う形になる
                - サービスの性質に依存するので、よく考えて見積もる
    - 利用ツール
        - Chapter 4 参照
    - 実施環境
        - 理想は商用環境とまったく同じ構成の負荷試験環境を構築すること
            - クラウドなら時間単位の課金なので、低コストで済む
            - c4.large を 100 台同時に稼働させても、 1 時間なら 1,400 円（！）
        - 外部システムと結合できない場合には以下のような対策が必要
            - 該当の外部システムのダミー応答をするスタブサーバを構築する（こちらの方が望ましい）
            - プログラム内部で外部システム連携部分のスタブを準備する
    - シナリオ
        - 各シナリオがどのサブシステムに影響するかは洗い出すこと
        - 実行負荷が高く、レイテンシを悪化させやすい部分を重点的に
        - 以下のようなリクエストが含まれるようにシナリオ設計を行う
            - アクセス頻度の高いページ
                - サイトTOPページ
                - アプリ起動時に毎回リクエストがあるAPI
            - サーバリソースの消費量が高いことが想定されるページ
                - パスワードの暗号化や認証
                - 画像・動画の変換処理
                - ファイルの圧縮・展開
                - コンテンツサイズが大きい
                - 画像・動画のアップロード・ダウンロード
                - ログ出力内容が多い
                - ファイル内の検索処理
            - DBの参照をするページ
                - 複数のユーザーが同じリソースを参照し、同じ応答を返すページ
                    - マスタデータの参照ページ
                    - 全員が必ず最新のユーザー投稿を参照するページ
                - リソース全体の横断検索をしたうえで結果を応答するページ
                    - ポイントランキングのリアルタイム表示ページ
                    - ユーザー投稿の最新順リスト表示ページ
                    - 自分と属性の近いユーザーの検索・表示ページ
                - アクセスするユーザーごとに異なるリソースを参照し、個別の応答を返すページ
                    - ユーザー別のマイページ
                    - ユーザーの属性に依存した結果を表示するページ
                    - ユーザーの所有するタイムライン
            - DBの更新をするページ
                - 複数のユーザーが同じリソースを更新するページ
                    - 商品の在庫引当て処理
                    - オークションの入札処理
                - ユーザーごとに異なるリソースを更新するページ
                    - コメント投稿ページ
                    - あしあと機能
                    - ログインセッションの発行ページ
            - 外部のシステムと通信するページ
                - 共有キャッシュサーバを利用するページ
                - ログを外部システムに転送するページ
                - SNSやSQSなどのシステムの利用
                - その他、外部APIとの通信を発生させるページ

### Chapter 6
- 負荷試験環境の準備
    - インフラ構築に関しては以下について注意する
        - LBを利用する場合でも、配下のアプリケーションサーバへの直接のリクエストを許可しておく
        - LBの前に別のルーティングをする場合でも、LBを直接叩くエンドポイントを利用可能としておく
        - アクセスログに実行時間を追加するように変更しておく
        - HTTPでのアクセスを許可しておく
        - 外部のシステムとの結合ポイントのon/offができるようにスタブなどを用意しておく
    - アプリケーションに以下を追加しておく
        - 静的なコンテンツを返答するだけのURL
        - Webフレームワークを利用したHelloWorldページを返答するURL
- 負荷試験ツールの準備
    - 攻撃サーバの構築
        - 攻撃ツール・モニタリングツール・プロファイリングツールのインストール
    - シナリオの作成
        - 計画時に立案した全体を通したシナリオ
        - 各箇所ごとの個別のシナリオ
        - 攻撃対象サーバ上の静的なファイルを取得するシナリオ
        - Webフレームワークを利用したHelloWorldのURLを取得するシナリオ
- 関連システムの部門間調整
    - 事前通知
    - モニタリング方法の調整
- クラウド事業者の各種制限の緩和申請
    - AWS WAF には秒間リクエスト数に制限がある

### Chapter 7
- 負荷試験実施のステップ
    - 全体にいきなり負荷試験を実施しても、その試験結果が妥当なのかやボトルネックを特定するのは非常に困難（モニタリングしていたとしても）
    - ステップ・バイ・ステップで狭い範囲から段取りを組んで実施していくことで、問題の切り分けを容易にするのが大事
- 段取りに従った負荷試験
    1. ツールや環境の検証
        - 方法
            - ローカルホストの静的ファイルに対して負荷をかける
        - 目的
            - 攻撃ツールでかけられる負荷の上限および計測可能なスループットの上限を計測する
        - 確認
            - ボトルネックが攻撃ツールにあるのかシステムにあるのか
        - 目安
            - 数千rps以上のスループット
    1. Webフレームワークの検証
        - 方法
            - ローカルホストのHelloWorldページに対して負荷をかける
        - 目的
            - Webフレームワークでの最速値を計測する
        - 確認
            - CPUを使い切れているか
            - 前のステップから著しいレイテンシやスループットの劣化がないか
        - 目安
            - CPUほぼ100%（ここではメモリ枯渇はほぼないはず）
            - 静的なファイルへのアクセスと比較して1/10以下のスループットとなることもある
    1. データベース参照系の性能検証
        - 方法
            - ローカルホストに対して負荷をかける
            - データベースに対して参照のみを行うページのうち、試験しやすいもの1つ＋個別でチューニングしておきたいページがあれば
            - 運用時と同等の量のダミーデータを用意する
            - 複数ユーザーからのアクセスをシミュレートする場合、参照するデータが分散するようにすること
        - 目的
            - キャッシュシステムの利用やDBの参照部分にフォーカスした試験を行う
        - 確認
            - Webサーバのリソースを十分に使えているか
            - DBのリソースを十分に使えているか
            - 前のステップから著しいレイテンシやスループットの劣化がないか
            - WebサーバもしくはDBのいずれかが逼迫しているか
        - 目安
            - Webサーバ側にボトルネックが発生することが多い
    1. データベース更新系の性能検証
        - 方法
            - ローカルホストに対して負荷をかける
            - データベースに対して更新のみを行うページのうち、試験しやすいもの1つ＋個別でチューニングしておきたいページがあれば
            - 運用時と同等の量のダミーデータを用意する
            - 複数ユーザーからのアクセスをシミュレートする場合、更新するデータが分散するようにすること
        - 目的
            - DBの更新処理にフォーカスした試験を行う
        - 確認
            - Webサーバのリソースを十分に使えているか
            - DBのリソースを十分に使えているか
            - 前のステップから著しいレイテンシやスループットの劣化がないか
            - WebサーバもしくはDBのいずれかが逼迫しているか
            - データの状態・ログ出力内容
        - 目安
            - Webサーバ側にボトルネックが発生することが多い
    1. 外部サービス連携の性能検証
        - 方法
            - ローカルホストに対して負荷をかける
            - 外部WebAPI呼び出し・S3やDynamoDBなどの外部サービス呼び出しを含むページ
            - ネットワークを中心に試験ができればよいので、外部システムに負荷をかけることが難しい場合には、スタブサーバを構築してそちらに静的なファイルを置くなどして対応する
        - 目的
            - 外部システムとの結合にフォーカスした試験を行う
        - 確認
            - Webサーバのリソースを十分に使えているか
            - DBのリソースを十分に使えているか
            - 前のステップから著しいレイテンシやスループットの劣化がないか
            - WebサーバもしくはDBのいずれかが逼迫しているか
            - 外部システムのリソース使用状況は逼迫していないか
            - 外部システムのレイテンシに問題はないか
        - 目安
            - このステップでは明確なボトルネックが観測できなくなってしまいがち
                - そうなったらボトルネックが外部サービスにあると推測する
    1. シナリオ試験
        - 方法
            - ローカルホストに対して負荷をかける
            - セッション的な手続きのあるシナリオを組む
            - 実際のユーザーのアクセスをシミュレートしたシナリオを組む
        - 目的
            - 攻撃ツールで負荷試験シナリオを組み、該当シナリオに従った試験を行う
        - 確認
            - シナリオが正常に実行できているか
            - Webサーバのリソースを十分に使えているか
            - DBのリソースを十分に使えているか
            - 前のステップから著しいレイテンシやスループットの劣化がないか
            - WebサーバもしくはDBのいずれかが逼迫しているか
            - データの状態・ログ出力内容
    1. スケールアウト試験準備
        - 方法
            - ロードバランサーに対して負荷をかける
            - これまで実施してきた試験をすべて再実行する
            - Webサーバは1台のみとする
        - 目的
            - スケールアウト試験の準備をするため、グローバルセグメントからの攻撃が適切に行われることを確認する
            - 独立した攻撃サーバからかけられる攻撃の限界値を計測する
        - 確認
            - 前のステップから著しいレイテンシやスループットの劣化がないか
    1. スケールアップ／アウト試験
        - 方法
            - ロードバランサーに対して負荷をかける
            - これまで実施してきた試験をすべて再実行する
            - ボトルネックをスケールアップまたはスケールアウトしながら再試験を繰り返す
        - 目的
            - システム性能がスケールアップやスケールアウトに追従して改善することを確認する
            - 今まで負荷がかかっていなかった各サブシステムそれぞれに適切な負荷をかけて、それぞれのチューニングを行う
        - 確認
            - これまでボトルネックとならなかった部分がボトルネックとなった際の挙動
            - シナリオが正常に実行できているか
            - Webサーバのリソースを十分に使えているか
            - DBのリソースを十分に使えているか
            - スケールアップ・スケールアウトに性能が追従するか
            - データの状態・ログ出力内容
        - 目安
            - 最初にボトルネックとなっているのはWebサーバのCPUであることがほとんど
                - 台数を 2台 -> 4台 -> 8台 -> 16台 と増やしていく
            - システム全体の性能が目標値を上回るか、攻撃ツールの限界まで負荷がかかった時点で終了とする
    1. 限界性能試験
        - 方法
            - 攻撃サーバ1台では十分な負荷がかけられなかった場合、攻撃サーバをスケールアウトして負荷をかける
            - ロードバランサーに対して負荷をかける
            - これまで実施してきた試験をすべて再実行する
            - ボトルネックをスケールアップまたはスケールアウトしながら再試験を繰り返す
        - 目的
            - 単体の攻撃サーバからでは負荷をかけきれない、より大規模なシステムにおける負荷試験を実施する
            - 将来のリソース増強のためのマイルストーンを見積もる
        - 確認
            - 攻撃サーバを追加することでシステムのスループットが増えるか
            - 試験結果が目標値をクリアしているか
            - より高負荷においてもシステムがスケール性を持つか
        - 目安
            - 目標値をすでに上回っていれば省略しても構わない

### Chapter 9
- 負荷試験レポート項目
    - 前提条件
    - 試験目的
    - 目標値
    - 試験対象システムの概要
    - 試験結果
    - システム性能評価
    - システムの課題
    - 付録：試験時の各リソースの利用状況など
